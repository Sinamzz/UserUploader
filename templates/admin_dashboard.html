{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="card p-4">
    <h1 class="mb-4">داشبورد ادمین</h1>

    <!-- تغییر فاز -->
    <h2>تغییر فاز پروژه</h2>
    <form method="POST" class="mb-4">
        {% csrf_token %}
        <div class="mb-3">
            <label for="phase_select" class="form-label">فاز پروژه:</label>
            <select name="phase_select" id="phase_select" class="form-select">
                <option value="1" {% if phase.is_phase_one %}selected{% endif %}>فاز اول</option>
                <option value="2" {% if not phase.is_phase_one %}selected{% endif %}>فاز دوم</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">تغییر فاز</button>
    </form>

    <!-- ایجاد کاربر -->
    <h2>ایجاد کاربر جدید</h2>
    <form method="POST" class="mb-4">
        {% csrf_token %}
        {% if form.errors %}
            <div class="alert alert-danger">
                {% for field in form %}
                    {% for error in field.errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
        {{ form.as_p }}
        <button type="submit" name="create_user" class="btn btn-primary">ایجاد کاربر</button>
    </form>

    <!-- لیست کاربران و فایل‌ها -->
    <h2>کاربران و فایل‌های آن‌ها</h2>
    {% for data in user_data %}
        <div class="card mb-3">
            <div class="card-body">
                <h3 class="card-title">کاربر: {{ data.user.username }}</h3>
                <p>نوع کاربر: {{ data.profile.get_user_type_display }}</p>
                <p>پژوهشسرا: {{ data.profile.get_region_display }}</p>
                {% if data.profile.field %}
                    <p>رشته: {{ data.profile.get_field_display }}</p>
                {% endif %}
                <p>فضای استفاده‌شده: {{ data.used_storage|filesizeformat }} / {{ data.profile.allowed_storage|filesizeformat }}</p>
                <h4>فایل‌ها:</h4>
                <ul class="list-group">
                    {% for file in data.files %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ file.get_field_display }} ({{ file.size|filesizeformat }})
                            <div>
                                <a href="#" class="btn btn-sm btn-primary me-2 download-btn" data-file-id="{{ file.id }}">دانلود</a>
                                <a href="{% url 'admin_delete_file' file.id %}" class="btn btn-sm btn-danger">حذف</a>
                            </div>
                        </li>
                    {% empty %}
                        <li class="list-group-item">بدون فایل</li>
                    {% endfor %}
                </ul>
                <a href="{% url 'admin_delete_user' data.user.id %}" class="btn btn-danger mt-2">حذف کاربر</a>
            </div>
        </div>
    {% empty %}
        <p>کاربری یافت نشد.</p>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const downloadButtons = document.querySelectorAll('.download-btn');

    downloadButtons.forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            const fileId = this.getAttribute('data-file-id');
            try {
                const response = await fetch(`/download/${fileId}/`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                const data = await response.json();
                if (data.download_url) {
                    window.location.href = data.download_url;
                } else {
                    alert('خطا در دریافت لینک دانلود: ' + data.error);
                }
            } catch (error) {
                alert('خطا: ' + error.message);
            }
        });
    });
});
</script>
{% endblock %}